import sqlite3
import logging
from typing import List, Dict
from core.storage import BaseStorage

logger = logging.getLogger(__name__)

class SQLiteStorage(BaseStorage):
    def __init__(self, db_path: str):
        self.db_path = db_path

    async def store(self, records: List[Dict], source_config: Dict):
        if not records:
            logger.info(f"Нет записей для сохранения в {source_config.get('table', 'unknown')}")
            return
        table = source_config["table"]
        unique_columns = source_config.get("unique_columns", [])
        mode = source_config.get("mode", "insert")

        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        # Проверяем существование таблицы
        cursor.execute(f"SELECT name FROM sqlite_master WHERE type='table' AND name='{table}'")
        table_exists = cursor.fetchone()

        if not table_exists:
            # Таблица не существует, создаём на основе первой записи
            first = records[0]
            if not first:
                logger.warning(f"Первая запись для {table} пуста, пропускаем создание таблицы")
                conn.close()
                return
            columns = list(first.keys())
            if not columns:
                logger.warning(f"Нет колонок для создания таблицы {table}, пропускаем")
                conn.close()
                return
            logger.info(f"Создание таблицы {table} с колонками: {columns}")
            col_defs = ", ".join([f'"{c}" TEXT' for c in columns])
            cursor.execute(f'CREATE TABLE "{table}" ({col_defs})')
            conn.commit()
            existing_columns = columns
        else:
            cursor.execute(f"PRAGMA table_info('{table}')")
            existing_columns = [row[1] for row in cursor.fetchall()]

            all_fields = set()
            for rec in records:
                all_fields.update(rec.keys())

            for field in all_fields:
                if field not in existing_columns:
                    try:
                        cursor.execute(f'ALTER TABLE "{table}" ADD COLUMN "{field}" TEXT')
                        logger.info(f"Добавлена колонка {field} в таблицу {table}")
                    except sqlite3.OperationalError as e:
                        logger.warning(f"Не удалось добавить колонку {field}: {e}")

        if mode == "overwrite":
            cursor.execute(f'DELETE FROM "{table}"')

        all_fields = set()
        for rec in records:
            all_fields.update(rec.keys())
        columns = list(all_fields)
        placeholders = ", ".join(["?"] * len(columns))
        col_names = ", ".join([f'"{c}"' for c in columns])

        if unique_columns:
            insert_sql = f'INSERT OR REPLACE INTO "{table}" ({col_names}) VALUES ({placeholders})'
        else:
            insert_sql = f'INSERT INTO "{table}" ({col_names}) VALUES ({placeholders})'

        data = [tuple(rec.get(c) for c in columns) for rec in records]
        cursor.executemany(insert_sql, data)

        conn.commit()
        conn.close()
