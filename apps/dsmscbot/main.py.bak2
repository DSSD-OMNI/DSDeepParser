#!/usr/bin/env python3
"""
–ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ v2.1
–° –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π, –∫–∞–ª–∏–±—Ä–æ–≤–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
"""

import os
import sys
import json
import logging
import yaml
from pathlib import Path
from tqdm import tqdm
from typing import List, Dict
from datetime import datetime
from dotenv import load_dotenv
import concurrent.futures
import numpy as np

from music_analyzer import analyze_track
from spotify_analyzer import SpotifyAnalyzer
from rekordbox_xml import create_rekordbox_xml
from playlist_exporter import export_playlists_by_genre

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
def setup_logging(config):
    log_config = config.get('logging', {})
    level = getattr(logging, log_config.get('level', 'INFO'))
    handlers = []
    
    if log_config.get('console', True):
        handlers.append(logging.StreamHandler())
    
    log_file = log_config.get('file')
    if log_file:
        log_path = Path(__file__).parent.parent / log_file
        log_path.parent.mkdir(exist_ok=True)
        handlers.append(logging.FileHandler(log_path, encoding='utf-8'))
    
    logging.basicConfig(
        level=level,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=handlers
    )
    
    # –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ –ª–æ–≥–∏ –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
    logging.getLogger('spotipy').setLevel(logging.WARNING)
    logging.getLogger('librosa').setLevel(logging.WARNING)


class MusicLibraryProcessor:
    """–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π"""
    
    SUPPORTED_FORMATS = ['.mp3', '.flac', '.wav', '.aiff', '.m4a', '.aac']
    
    def __init__(self, config: dict):
        self.config = config
        self.use_spotify = config.get('spotify', {}).get('enabled', True)
        self.parallel = config.get('parallel', {}).get('enabled', True)
        self.max_workers = config.get('parallel', {}).get('max_workers', 0)
        self.calibrate_energy = config.get('analysis', {}).get('calibrate_energy', True)
        
        self.spotify = SpotifyAnalyzer(
            cache_enabled=config.get('spotify', {}).get('cache_enabled', True),
            config=config.get('spotify', {})
        ) if self.use_spotify else None
        
        self.results = []
        self.logger = logging.getLogger(__name__)
    
    def find_audio_files(self, library_path: str) -> List[str]:
        """–ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤"""
        self.logger.info(f"üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {library_path}")
        audio_files = []
        
        for root, dirs, files in os.walk(library_path):
            for file in files:
                if any(file.lower().endswith(ext) for ext in self.SUPPORTED_FORMATS):
                    audio_files.append(os.path.join(root, file))
        
        self.logger.info(f"‚úì –ù–∞–π–¥–µ–Ω–æ: {len(audio_files)} –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤")
        return audio_files
    
    def select_files_interactive(self, audio_files: List[str]) -> List[str]:
        """
        –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        """
        print("\n" + "="*70)
        print("–í–´–ë–û–† –¢–†–ï–ö–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê")
        print("="*70)
        
        print(f"\n–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: {len(audio_files)}")
        print("\n–í–∞—Ä–∏–∞–Ω—Ç—ã:")
        print("  1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –í–°–ï —Ç—Ä–µ–∫–∏")
        print("  2. –£–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤ (–ø–µ—Ä–≤—ã–µ N)")
        print("  3. –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–∞–ø–∫—É")
        print("  4. –í—ã–±—Ä–∞—Ç—å –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞")
        
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç [1-4]: ").strip()
        
        if choice == '1':
            return audio_files
        
        elif choice == '2':
            count = input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤: ").strip()
            try:
                count = int(count)
                return audio_files[:count]
            except:
                print("‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ")
                return audio_files
        
        elif choice == '3':
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏
            folders = set()
            for file in audio_files:
                folders.add(os.path.dirname(file))
            
            folders_list = sorted(folders)
            print(f"\n–ù–∞–π–¥–µ–Ω–æ –ø–∞–ø–æ–∫: {len(folders_list)}")
            print("\n–ü–µ—Ä–≤—ã–µ 20 –ø–∞–ø–æ–∫:")
            for i, folder in enumerate(folders_list[:20], 1):
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å –ø—É—Ç–∏
                short_path = os.path.basename(folder) or folder
                print(f"  {i}. {short_path}")
            
            if len(folders_list) > 20:
                print(f"  ... –∏ –µ—â—ë {len(folders_list) - 20} –ø–∞–ø–æ–∫")
            
            folder_input = input("\n–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –ø—É—Ç–∏ –ø–∞–ø–∫–∏: ").strip()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø–∞–ø–∫–µ
            selected = [f for f in audio_files if folder_input.lower() in f.lower()]
            print(f"‚úì –í—ã–±—Ä–∞–Ω–æ: {len(selected)} —Ç—Ä–µ–∫–æ–≤")
            return selected
        
        elif choice == '4':
            print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:")
            formats = {}
            for file in audio_files:
                ext = os.path.splitext(file)[1].lower()
                formats[ext] = formats.get(ext, 0) + 1
            
            for ext, count in sorted(formats.items()):
                print(f"  {ext}: {count} —Ñ–∞–π–ª–æ–≤")
            
            ext_choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: .mp3): ").strip().lower()
            if not ext_choice.startswith('.'):
                ext_choice = '.' + ext_choice
            
            selected = [f for f in audio_files if f.lower().endswith(ext_choice)]
            print(f"‚úì –í—ã–±—Ä–∞–Ω–æ: {len(selected)} —Ç—Ä–µ–∫–æ–≤")
            return selected
        
        else:
            print("‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ")
            return audio_files
    
    def process_files(self, files: List[str], save_progress: bool = True) -> List[Dict]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)"""
        self.logger.info(f"üéµ –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ {len(files)} —Ç—Ä–µ–∫–æ–≤...")
        
        if self.parallel and len(files) > 1:
            return self._process_files_parallel(files, save_progress)
        else:
            return self._process_files_sequential(files, save_progress)
    
    def _process_files_sequential(self, files: List[str], save_progress: bool) -> List[Dict]:
        """–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞"""
        self.logger.info("–†–µ–∂–∏–º: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π")
        for file_path in tqdm(files, desc="–ê–Ω–∞–ª–∏–∑", unit="—Ç—Ä–µ–∫", ncols=100):
            self._analyze_one(file_path, save_progress)
        return self.results
    
    def _process_files_parallel(self, files: List[str], save_progress: bool) -> List[Dict]:
        """–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞"""
        workers = self.max_workers if self.max_workers > 0 else None
        self.logger.info(f"–†–µ–∂–∏–º: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π (–≤–æ—Ä–∫–µ—Ä–æ–≤: {workers or os.cpu_count()})")
        
        with concurrent.futures.ProcessPoolExecutor(max_workers=workers) as executor:
            futures = {executor.submit(analyze_track, f): f for f in files}
            
            with tqdm(total=len(files), desc="–ê–Ω–∞–ª–∏–∑", unit="—Ç—Ä–µ–∫", ncols=100) as pbar:
                for future in concurrent.futures.as_completed(futures):
                    file_path = futures[future]
                    try:
                        result = future.result()
                        if result:
                            # –û–±–æ–≥–∞—â–µ–Ω–∏–µ Spotify (–¥–µ–ª–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ, —Ç.–∫. —Ç–∞–º —Å–µ—Ç—å)
                            if self.use_spotify and self.spotify:
                                result = self.spotify.enrich_track_data(result)
                            else:
                                result['genre'] = result.get('existing_genre', 'Unknown')
                                result['spotify_available'] = False
                            
                            self.results.append(result)
                            
                            pbar.set_postfix({
                                'BPM': f"{result['bpm']:.0f}",
                                'Genre': result.get('genre', 'Unknown')[:15],
                                'Energy': f"{result['energy_stars']}‚≠ê"
                            })
                            
                            if save_progress and len(self.results) % 50 == 0:
                                self._save_progress()
                    except Exception as e:
                        self.logger.error(f"‚ùå {os.path.basename(file_path)}: {e}")
                    finally:
                        pbar.update(1)
        
        self.logger.info(f"‚úì –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω: {len(self.results)} —Ç—Ä–µ–∫–æ–≤")
        if save_progress:
            self._save_progress()
        
        return self.results
    
    def _analyze_one(self, file_path: str, save_progress: bool):
        """–ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞ (–¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)"""
        try:
            result = analyze_track(file_path)
            if result:
                if self.use_spotify and self.spotify:
                    result = self.spotify.enrich_track_data(result)
                else:
                    result['genre'] = result.get('existing_genre', 'Unknown')
                    result['spotify_available'] = False
                
                self.results.append(result)
                
                if save_progress and len(self.results) % 50 == 0:
                    self._save_progress()
        except Exception as e:
            self.logger.error(f"‚ùå {os.path.basename(file_path)}: {e}")
    
    def _save_progress(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
        output_dir = Path(__file__).parent.parent / 'output'
        output_dir.mkdir(exist_ok=True)
        progress_file = output_dir / 'analysis_progress.json'
        with open(progress_file, 'w', encoding='utf-8') as f:
            json.dump(self.results, f, indent=2, ensure_ascii=False)
    
    def calibrate_energy_stars(self):
        """–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–≤—ë–∑–¥–æ—á–µ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–µ–π —ç–Ω–µ—Ä–≥–∏–∏"""
        if not self.results or not self.calibrate_energy:
            return
        
        energies = [t['energy'] for t in self.results]
        if len(energies) < 5:
            return
        
        # –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–∏
        p20 = np.percentile(energies, 20)
        p40 = np.percentile(energies, 40)
        p60 = np.percentile(energies, 60)
        p80 = np.percentile(energies, 80)
        
        self.logger.info(f"–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏: –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–∏ 20%={p20:.3f}, 40%={p40:.3f}, 60%={p60:.3f}, 80%={p80:.3f}")
        
        for track in self.results:
            e = track['energy']
            if e < p20:
                stars = 1
            elif e < p40:
                stars = 2
            elif e < p60:
                stars = 3
            elif e < p80:
                stars = 4
            else:
                stars = 5
            track['energy_stars'] = stars
    
    def generate_statistics(self) -> Dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        if not self.results:
            return {}
        
        # –ñ–∞–Ω—Ä—ã
        genres = {}
        for track in self.results:
            genre = track.get('genre', 'Unknown')
            genres[genre] = genres.get(genre, 0) + 1
        
        # BPM
        bpms = [t['bpm'] for t in self.results if t['bpm'] > 0]
        
        # –≠–Ω–µ—Ä–≥–∏—è
        energies = [t['energy'] for t in self.results]
        
        # –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        moods = {}
        for track in self.results:
            mood = track.get('mood', 'Unknown')
            moods[mood] = moods.get(mood, 0) + 1
        
        # –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        keys = {}
        for track in self.results:
            key = track.get('key', 'Unknown')
            keys[key] = keys.get(key, 0) + 1
        
        stats = {
            'total_tracks': len(self.results),
            'genres': genres,
            'moods': moods,
            'bpm_range': {
                'min': min(bpms) if bpms else 0,
                'max': max(bpms) if bpms else 0,
                'avg': sum(bpms) / len(bpms) if bpms else 0
            },
            'energy_range': {
                'min': min(energies) if energies else 0,
                'max': max(energies) if energies else 0,
                'avg': sum(energies) / len(energies) if energies else 0
            },
            'top_keys': dict(sorted(keys.items(), key=lambda x: x[1], reverse=True)[:10]),
            'spotify_coverage': sum(1 for t in self.results if t.get('spotify_available', False))
        }
        
        return stats
    
    def print_statistics(self):
        """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        stats = self.generate_statistics()
        
        print("\n" + "="*70)
        print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò")
        print("="*70)
        
        print(f"\nüéµ –í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤: {stats['total_tracks']}")
        
        print(f"\nüìÅ –ñ–∞–Ω—Ä—ã (—Ç–æ–ø-10):")
        for genre, count in sorted(stats['genres'].items(), key=lambda x: x[1], reverse=True)[:10]:
            percentage = (count / stats['total_tracks']) * 100
            print(f"  ‚Ä¢ {genre}: {count} ({percentage:.1f}%)")
        
        print(f"\nüí´ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:")
        for mood, count in sorted(stats['moods'].items(), key=lambda x: x[1], reverse=True):
            percentage = (count / stats['total_tracks']) * 100
            print(f"  ‚Ä¢ {mood}: {count} ({percentage:.1f}%)")
        
        print(f"\n‚ö° BPM:")
        print(f"  ‚Ä¢ –ú–∏–Ω–∏–º—É–º: {stats['bpm_range']['min']:.0f}")
        print(f"  ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: {stats['bpm_range']['max']:.0f}")
        print(f"  ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π: {stats['bpm_range']['avg']:.0f}")
        
        print(f"\nüéπ –¢–æ–ø —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:")
        for key, count in list(stats['top_keys'].items())[:10]:
            print(f"  ‚Ä¢ {key}: {count} —Ç—Ä–µ–∫–æ–≤")
        
        if stats.get('spotify_coverage'):
            coverage_pct = (stats['spotify_coverage'] / stats['total_tracks']) * 100
            print(f"\nüéß Spotify: {stats['spotify_coverage']} ({coverage_pct:.1f}%)")
        
        print("\n" + "="*70)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    config_path = Path(__file__).parent / 'config.yaml'
    if not config_path.exists():
        print("‚ö†Ô∏è  –§–∞–π–ª config.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω.")
        # –°–æ–∑–¥–∞—ë–º —à–∞–±–ª–æ–Ω
        default_config = {
            'library_path': '',
            'analysis': {
                'loop_bars': 8,
                'calibrate_energy': True,
                'energy_thresholds': [0.3, 0.5, 0.65, 0.82],
                'cue_colors': {
                    'intro': "40,226,20",
                    'buildup': "233,237,26",
                    'drop': "242,22,45",
                    'outro': "23,147,226"
                }
            },
            'spotify': {
                'enabled': True,
                'client_id': '',
                'client_secret': '',
                'cache_enabled': True,
                'cache_ttl_days': 30
            },
            'parallel': {
                'enabled': True,
                'max_workers': 0
            },
            'logging': {
                'level': 'INFO',
                'console': True,
                'file': 'output/analysis.log'
            }
        }
        with open(config_path, 'w', encoding='utf-8') as f:
            yaml.dump(default_config, f, allow_unicode=True, sort_keys=False)
        print(f"–°–æ–∑–¥–∞–Ω {config_path}. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.")
        sys.exit(0)
    
    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
    
    setup_logging(config)
    logger = logging.getLogger(__name__)
    
    print("="*70)
    print("üéß DJ MUSIC LIBRARY ANALYZER v2.1")
    print("="*70)
    
    # –ü—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
    library_path = config.get('library_path') or os.getenv('MUSIC_LIBRARY_PATH')
    
    if not library_path or not os.path.exists(library_path):
        logger.warning("‚ö†Ô∏è –ü—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –Ω–µ –∑–∞–¥–∞–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ")
        library_path = input("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ: ").strip()
        if not os.path.exists(library_path):
            logger.error("‚ùå –ü—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
            sys.exit(1)
    
    processor = MusicLibraryProcessor(config)
    
    all_files = processor.find_audio_files(library_path)
    if not all_files:
        logger.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤!")
        sys.exit(1)
    
    selected_files = processor.select_files_interactive(all_files)
    if not selected_files:
        logger.error("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤!")
        sys.exit(1)
    
    logger.info(f"‚úì –ö –∞–Ω–∞–ª–∏–∑—É: {len(selected_files)} —Ç—Ä–µ–∫–æ–≤")
    confirm = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) [y]: ").lower() or 'y'
    if confirm != 'y':
        logger.info("–û—Ç–º–µ–Ω–µ–Ω–æ")
        sys.exit(0)
    
    results = processor.process_files(selected_files)
    if not results:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏!")
        sys.exit(1)
    
    # –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–≤—ë–∑–¥–æ—á–µ–∫
    processor.calibrate_energy_stars()
    
    processor.print_statistics()
    
    # –≠–∫—Å–ø–æ—Ä—Ç
    output_dir = Path(__file__).parent.parent / 'output'
    output_dir.mkdir(exist_ok=True)
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    # Rekordbox XML
    logger.info("üìù –°–æ–∑–¥–∞–Ω–∏–µ Rekordbox XML...")
    xml_path = output_dir / f'rekordbox_import_{timestamp}.xml'
    create_rekordbox_xml(results, str(xml_path))
    
    # M3U/PLS
    logger.info("üìù –°–æ–∑–¥–∞–Ω–∏–µ M3U/PLS –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤...")
    playlist_dir = output_dir / f'playlists_{timestamp}'
    playlist_files = export_playlists_by_genre(results, str(playlist_dir))
    
    # JSON –æ—Ç—á—ë—Ç
    json_path = output_dir / f'analysis_report_{timestamp}.json'
    report = {
        'timestamp': timestamp,
        'library_path': library_path,
        'total_tracks': len(results),
        'statistics': processor.generate_statistics(),
        'tracks': results
    }
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(report, f, indent=2, ensure_ascii=False)
    
    logger.info(f"üíæ JSON –æ—Ç—á—ë—Ç: {json_path}")
    
    print("\n" + "="*70)
    print("‚úÖ –ì–û–¢–û–í–û!")
    print("="*70)
    print(f"\nüìÅ –§–∞–π–ª—ã –≤: {output_dir}")
    print(f"üéµ Rekordbox XML: {xml_path.name}")
    print(f"üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã: {playlist_dir.name}/ ({len(playlist_files)} —Ñ–∞–π–ª–æ–≤)")
    print(f"üìä JSON –æ—Ç—á—ë—Ç: {json_path.name}")
    print("\n" + "="*70)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
    except Exception as e:
        logging.exception("‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞")
        sys.exit(1)
