#!/usr/bin/env python3
"""
–ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ v2.0
–° –≤—ã–±–æ—Ä–æ–º —Ç—Ä–µ–∫–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
"""

import os
import sys
import json
from pathlib import Path
from tqdm import tqdm
from typing import List, Dict
from datetime import datetime
from dotenv import load_dotenv

from music_analyzer import analyze_track
from spotify_analyzer import SpotifyAnalyzer
from rekordbox_xml import create_rekordbox_xml
from playlist_exporter import export_playlists_by_genre

load_dotenv()


class MusicLibraryProcessor:
    """–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"""
    
    SUPPORTED_FORMATS = ['.mp3', '.flac', '.wav', '.aiff', '.m4a', '.aac']
    
    def __init__(self, use_spotify: bool = True):
        self.use_spotify = use_spotify
        self.spotify = SpotifyAnalyzer() if use_spotify else None
        self.results = []
    
    def find_audio_files(self, library_path: str) -> List[str]:
        """–ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤"""
        print(f"\nüîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {library_path}")
        
        audio_files = []
        
        for root, dirs, files in os.walk(library_path):
            for file in files:
                if any(file.lower().endswith(ext) for ext in self.SUPPORTED_FORMATS):
                    audio_files.append(os.path.join(root, file))
        
        print(f"‚úì –ù–∞–π–¥–µ–Ω–æ: {len(audio_files)} –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤")
        return audio_files
    
    def select_files_interactive(self, audio_files: List[str]) -> List[str]:
        """
        –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        """
        print("\n" + "="*70)
        print("–í–´–ë–û–† –¢–†–ï–ö–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê")
        print("="*70)
        
        print(f"\n–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: {len(audio_files)}")
        print("\n–í–∞—Ä–∏–∞–Ω—Ç—ã:")
        print("  1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –í–°–ï —Ç—Ä–µ–∫–∏")
        print("  2. –£–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤ (–ø–µ—Ä–≤—ã–µ N)")
        print("  3. –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–∞–ø–∫—É")
        print("  4. –í—ã–±—Ä–∞—Ç—å –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞")
        
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç [1-4]: ").strip()
        
        if choice == '1':
            return audio_files
        
        elif choice == '2':
            count = input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤: ").strip()
            try:
                count = int(count)
                return audio_files[:count]
            except:
                print("‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ")
                return audio_files
        
        elif choice == '3':
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏
            folders = set()
            for file in audio_files:
                folders.add(os.path.dirname(file))
            
            folders_list = sorted(folders)
            print(f"\n–ù–∞–π–¥–µ–Ω–æ –ø–∞–ø–æ–∫: {len(folders_list)}")
            print("\n–ü–µ—Ä–≤—ã–µ 20 –ø–∞–ø–æ–∫:")
            for i, folder in enumerate(folders_list[:20], 1):
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å –ø—É—Ç–∏
                short_path = os.path.basename(folder) or folder
                print(f"  {i}. {short_path}")
            
            if len(folders_list) > 20:
                print(f"  ... –∏ –µ—â—ë {len(folders_list) - 20} –ø–∞–ø–æ–∫")
            
            folder_input = input("\n–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –ø—É—Ç–∏ –ø–∞–ø–∫–∏: ").strip()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø–∞–ø–∫–µ
            selected = [f for f in audio_files if folder_input.lower() in f.lower()]
            print(f"‚úì –í—ã–±—Ä–∞–Ω–æ: {len(selected)} —Ç—Ä–µ–∫–æ–≤")
            return selected
        
        elif choice == '4':
            print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:")
            formats = {}
            for file in audio_files:
                ext = os.path.splitext(file)[1].lower()
                formats[ext] = formats.get(ext, 0) + 1
            
            for ext, count in sorted(formats.items()):
                print(f"  {ext}: {count} —Ñ–∞–π–ª–æ–≤")
            
            ext_choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: .mp3): ").strip().lower()
            if not ext_choice.startswith('.'):
                ext_choice = '.' + ext_choice
            
            selected = [f for f in audio_files if f.lower().endswith(ext_choice)]
            print(f"‚úì –í—ã–±—Ä–∞–Ω–æ: {len(selected)} —Ç—Ä–µ–∫–æ–≤")
            return selected
        
        else:
            print("‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ")
            return audio_files
    
    def process_files(self, files: List[str], save_progress: bool = True) -> List[Dict]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        print(f"\nüéµ –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ {len(files)} —Ç—Ä–µ–∫–æ–≤...")
        print("‚è≥ –≠—Ç–æ –∑–∞–π–º—ë—Ç –≤—Ä–µ–º—è (10-30 —Å–µ–∫ –Ω–∞ —Ç—Ä–µ–∫)\n")
        
        progress_bar = tqdm(files, desc="–ê–Ω–∞–ª–∏–∑", unit="—Ç—Ä–µ–∫", ncols=100)
        
        for file_path in progress_bar:
            try:
                result = analyze_track(file_path)
                
                if result:
                    # –û–±–æ–≥–∞—â–µ–Ω–∏–µ Spotify
                    if self.use_spotify and self.spotify and self.spotify.sp:
                        result = self.spotify.enrich_track_data(result)
                    else:
                        result['genre'] = result.get('existing_genre', 'Unknown')
                        result['spotify_available'] = False
                    
                    self.results.append(result)
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    progress_bar.set_postfix({
                        'BPM': f"{result['bpm']:.0f}",
                        'Genre': result.get('genre', 'Unknown')[:15],
                        'Energy': f"{result['energy_stars']}‚≠ê"
                    })
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 50 —Ç—Ä–µ–∫–æ–≤
                    if save_progress and len(self.results) % 50 == 0:
                        self._save_progress()
                
            except Exception as e:
                progress_bar.write(f"‚ùå {os.path.basename(file_path)}: {e}")
                continue
        
        print(f"\n‚úì –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω: {len(self.results)} —Ç—Ä–µ–∫–æ–≤")
        
        if save_progress:
            self._save_progress()
        
        return self.results
    
    def _save_progress(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
        output_dir = Path(__file__).parent.parent / 'output'
        output_dir.mkdir(exist_ok=True)
        
        progress_file = output_dir / 'analysis_progress.json'
        
        with open(progress_file, 'w', encoding='utf-8') as f:
            json.dump(self.results, f, indent=2, ensure_ascii=False)
    
    def generate_statistics(self) -> Dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        if not self.results:
            return {}
        
        # –ñ–∞–Ω—Ä—ã
        genres = {}
        for track in self.results:
            genre = track.get('genre', 'Unknown')
            genres[genre] = genres.get(genre, 0) + 1
        
        # BPM
        bpms = [t['bpm'] for t in self.results if t['bpm'] > 0]
        
        # –≠–Ω–µ—Ä–≥–∏—è
        energies = [t['energy'] for t in self.results]
        
        # –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        moods = {}
        for track in self.results:
            mood = track.get('mood', 'Unknown')
            moods[mood] = moods.get(mood, 0) + 1
        
        # –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        keys = {}
        for track in self.results:
            key = track.get('key', 'Unknown')
            keys[key] = keys.get(key, 0) + 1
        
        stats = {
            'total_tracks': len(self.results),
            'genres': genres,
            'moods': moods,
            'bpm_range': {
                'min': min(bpms) if bpms else 0,
                'max': max(bpms) if bpms else 0,
                'avg': sum(bpms) / len(bpms) if bpms else 0
            },
            'energy_range': {
                'min': min(energies) if energies else 0,
                'max': max(energies) if energies else 0,
                'avg': sum(energies) / len(energies) if energies else 0
            },
            'top_keys': dict(sorted(keys.items(), key=lambda x: x[1], reverse=True)[:10]),
            'spotify_coverage': sum(1 for t in self.results if t.get('spotify_available', False))
        }
        
        return stats
    
    def print_statistics(self):
        """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        stats = self.generate_statistics()
        
        print("\n" + "="*70)
        print("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò")
        print("="*70)
        
        print(f"\nüéµ –í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤: {stats['total_tracks']}")
        
        print(f"\nüìÅ –ñ–∞–Ω—Ä—ã (—Ç–æ–ø-10):")
        for genre, count in sorted(stats['genres'].items(), key=lambda x: x[1], reverse=True)[:10]:
            percentage = (count / stats['total_tracks']) * 100
            print(f"  ‚Ä¢ {genre}: {count} ({percentage:.1f}%)")
        
        print(f"\nüí´ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:")
        for mood, count in sorted(stats['moods'].items(), key=lambda x: x[1], reverse=True):
            percentage = (count / stats['total_tracks']) * 100
            print(f"  ‚Ä¢ {mood}: {count} ({percentage:.1f}%)")
        
        print(f"\n‚ö° BPM:")
        print(f"  ‚Ä¢ –ú–∏–Ω–∏–º—É–º: {stats['bpm_range']['min']:.0f}")
        print(f"  ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: {stats['bpm_range']['max']:.0f}")
        print(f"  ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π: {stats['bpm_range']['avg']:.0f}")
        
        print(f"\nüéπ –¢–æ–ø —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π:")
        for key, count in list(stats['top_keys'].items())[:10]:
            print(f"  ‚Ä¢ {key}: {count} —Ç—Ä–µ–∫–æ–≤")
        
        if stats.get('spotify_coverage'):
            coverage_pct = (stats['spotify_coverage'] / stats['total_tracks']) * 100
            print(f"\nüéß Spotify: {stats['spotify_coverage']} ({coverage_pct:.1f}%)")
        
        print("\n" + "="*70)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("="*70)
    print("üéß DJ MUSIC LIBRARY ANALYZER v2.0")
    print("="*70)
    
    # –ü—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
    library_path = os.getenv('MUSIC_LIBRARY_PATH')
    
    if not library_path or not os.path.exists(library_path):
        print("\n‚ö†Ô∏è  –ü—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –Ω–µ –∑–∞–¥–∞–Ω")
        library_path = input("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ: ").strip()
        
        if not os.path.exists(library_path):
            print("‚ùå –ü—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
            sys.exit(1)
    
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
    processor = MusicLibraryProcessor(use_spotify=True)
    
    # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã
    all_files = processor.find_audio_files(library_path)
    
    if not all_files:
        print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤!")
        sys.exit(1)
    
    # –í—ã–±–∏—Ä–∞–µ–º —Ñ–∞–π–ª—ã
    selected_files = processor.select_files_interactive(all_files)
    
    if not selected_files:
        print("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤!")
        sys.exit(1)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    print(f"\n‚úì –ö –∞–Ω–∞–ª–∏–∑—É: {len(selected_files)} —Ç—Ä–µ–∫–æ–≤")
    confirm = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) [y]: ").lower() or 'y'
    
    if confirm != 'y':
        print("–û—Ç–º–µ–Ω–µ–Ω–æ")
        sys.exit(0)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
    results = processor.process_files(selected_files)
    
    if not results:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏!")
        sys.exit(1)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    processor.print_statistics()
    
    # –°–æ–∑–¥–∞—ë–º –≤—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
    output_dir = Path(__file__).parent.parent / 'output'
    output_dir.mkdir(exist_ok=True)
    
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    # 1. Rekordbox XML
    print(f"\nüìù –°–æ–∑–¥–∞–Ω–∏–µ Rekordbox XML...")
    xml_path = output_dir / f'rekordbox_import_{timestamp}.xml'
    create_rekordbox_xml(results, str(xml_path))
    
    # 2. M3U –∏ PLS –ø–ª–µ–π–ª–∏—Å—Ç—ã
    print(f"\nüìù –°–æ–∑–¥–∞–Ω–∏–µ M3U/PLS –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤...")
    playlist_dir = output_dir / f'playlists_{timestamp}'
    playlist_files = export_playlists_by_genre(results, str(playlist_dir))
    
    # 3. JSON –æ—Ç—á—ë—Ç
    json_path = output_dir / f'analysis_report_{timestamp}.json'
    report = {
        'timestamp': timestamp,
        'library_path': library_path,
        'total_tracks': len(results),
        'statistics': processor.generate_statistics(),
        'tracks': results
    }
    
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(report, f, indent=2, ensure_ascii=False)
    
    print(f"üíæ JSON –æ—Ç—á—ë—Ç: {json_path}")
    
    # –ò—Ç–æ–≥–∏
    print("\n" + "="*70)
    print("‚úÖ –ì–û–¢–û–í–û!")
    print("="*70)
    print(f"\nüìÅ –§–∞–π–ª—ã –≤: {output_dir}")
    print(f"\nüéµ Rekordbox XML: {xml_path.name}")
    print(f"üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã M3U/PLS: {playlist_dir.name}/ ({len(playlist_files)} —Ñ–∞–π–ª–æ–≤)")
    print(f"üìä JSON –æ—Ç—á—ë—Ç: {json_path.name}")
    print("\nüí° –ò–º–ø–æ—Ä—Ç –≤ Rekordbox:")
    print("   1. File ‚Üí Import Collection (–¥–ª—è XML)")
    print("   2. File ‚Üí Import Playlist (–¥–ª—è M3U/PLS)")
    print("\n" + "="*70)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
