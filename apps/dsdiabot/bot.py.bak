import os
import logging
import csv
from io import StringIO
from datetime import datetime, timedelta
from dotenv import load_dotenv
from telegram import Update, InputFile
from telegram.ext import Application, CommandHandler, CallbackContext, JobQueue
import database as db

load_dotenv()
TOKEN = os.getenv('TELEGRAM_TOKEN')
if not TOKEN:
    raise ValueError("No TELEGRAM_TOKEN found in .env file")

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

db.init_db()

# === –ö–æ–º–∞–Ω–¥—ã ===
async def start(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    db.add_user(user_id)
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–∏–∞–±–µ—Ç–∏–∫–æ–≤.\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/add_sugar <–º–º–æ–ª—å> ‚Äì –∑–∞–ø–∏—Å–∞—Ç—å —Å–∞—Ö–∞—Ä\n"
        "/add_meal <–•–ï> ‚Äì –∑–∞–ø–∏—Å–∞—Ç—å –µ–¥—É\n"
        "/stats ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏\n"
        "/setprofile <—á—É–≤—Å—Ç–≤> <—É–≥–ª.–∫–æ—ç—Ñ> <—Ü–µ–ª—å> ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–ø—Ä–∏–º–µ—Ä: /setprofile 2 1.5 6)\n"
        "/bolus <—Ç–µ–∫.—Å–∞—Ö–∞—Ä> [<—Ü–µ–ª—å>] [<—Ö–µ>] ‚Äì —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–æ–ª—é—Å (–µ—Å–ª–∏ —Ü–µ–ª—å –∏ —Ö–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã, –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)\n"
        "/remind [–º–∏–Ω—É—Ç—ã] ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ‚Äì —Å–ø–∏—Å–æ–∫)\n"
        "/remind_cancel <id> ‚Äì –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "/export ‚Äì –≤—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ CSV\n"
        "/help ‚Äì –ø–æ–º–æ—â—å"
    )

async def help_command(update: Update, context: CallbackContext):
    await update.message.reply_text(
        "üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞:\n\n"
        "/add_sugar 5.6 ‚Äì –∑–∞–ø–∏—Å–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –≥–ª—é–∫–æ–∑—ã\n"
        "/add_meal 3.5 ‚Äì –∑–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –•–ï\n"
        "/stats ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π —Å–∞—Ö–∞—Ä–∞ –∏ –µ–¥—ã\n"
        "/setprofile 2 1.5 6 ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:\n"
        "   ‚Ä¢ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∏–Ω—Å—É–ª–∏–Ω—É (–Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–º–æ–ª—å —Å–Ω–∏–∂–∞–µ—Ç 1 –µ–¥)\n"
        "   ‚Ä¢ —É–≥–ª–µ–≤–æ–¥–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–•–ï –Ω–∞ 1 –µ–¥ –∏–Ω—Å—É–ª–∏–Ω–∞)\n"
        "   ‚Ä¢ —Ü–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ (–º–º–æ–ª—å)\n"
        "/bolus 10 ‚Äì —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–∑—É, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ—Ñ–∏–ª—å (—É–∫–∞–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏—é)\n"
        "/bolus 10 6 4 ‚Äì –≤—Å—ë –≤—Ä—É—á–Ω—É—é: —Ç–µ–∫.—Å–∞—Ö–∞—Ä=10, —Ü–µ–ª—å=6, –•–ï=4 (–∫–æ—ç—Ñ. –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)\n"
        "/remind 60 ‚Äì –Ω–∞–ø–æ–º–Ω–∏—Ç —á–µ—Ä–µ–∑ 60 –º–∏–Ω—É—Ç, –∑–∞—Ç–µ–º –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å\n"
        "/remind ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
        "/remind_cancel 3 ‚Äì –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –Ω–æ–º–µ—Ä–æ–º 3\n"
        "/export ‚Äì –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –∑–∞–ø–∏—Å—è–º–∏\n"
    )

async def add_sugar(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    try:
        value = float(context.args[0])
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_sugar <—á–∏—Å–ª–æ> (–Ω–∞–ø—Ä–∏–º–µ—Ä, /add_sugar 5.6)")
        return
    db.add_glucose(user_id, value)
    await update.message.reply_text(f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω —Å–∞—Ö–∞—Ä: {value} –º–º–æ–ª—å")

async def add_meal(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    try:
        carbs = float(context.args[0])
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_meal <—á–∏—Å–ª–æ> (–Ω–∞–ø—Ä–∏–º–µ—Ä, /add_meal 3.5)")
        return
    db.add_meal(user_id, carbs)
    await update.message.reply_text(f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–∞ –µ–¥–∞: {carbs} –•–ï")

async def stats(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    sugars = db.get_last_glucose(user_id, 5)
    meals = db.get_last_meals(user_id, 5)
    msg = "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏:\n\n"
    if sugars:
        msg += "üîπ **–°–∞—Ö–∞—Ä:**\n"
        for val, ts in sugars:
            msg += f"   {val} –º–º–æ–ª—å  ({ts[:16]})\n"
    else:
        msg += "üîπ –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å–∞—Ö–∞—Ä–∞.\n"
    if meals:
        msg += "\nüî∏ **–ï–¥–∞ (–•–ï):**\n"
        for carbs, ts in meals:
            msg += f"   {carbs} –•–ï  ({ts[:16]})\n"
    else:
        msg += "\nüî∏ –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –µ–¥—ã.\n"
    await update.message.reply_text(msg, parse_mode='Markdown')

async def setprofile(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    try:
        sensitivity = float(context.args[0])
        insulin_to_carb = float(context.args[1])
        target = float(context.args[2])
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /setprofile <—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å> <—É–≥–ª.–∫–æ—ç—Ñ> <—Ü–µ–ª—å>\n–ü—Ä–∏–º–µ—Ä: /setprofile 2 1.5 6")
        return
    db.set_user_settings(user_id, sensitivity, insulin_to_carb, target)
    await update.message.reply_text("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")

async def bolus(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    settings = db.get_user_settings(user_id)
    if not settings:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–∞–Ω–¥–æ–π /setprofile")
        return
    sensitivity, insulin_to_carb, target = settings
    try:
        if len(context.args) == 1:
            current = float(context.args[0])
            carbs = 0
            target_glucose = target
        elif len(context.args) == 3:
            current = float(context.args[0])
            target_glucose = float(context.args[1])
            carbs = float(context.args[2])
        else:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n/bolus <—Ç–µ–∫.—Å–∞—Ö–∞—Ä>  (—Å –ø—Ä–æ—Ñ–∏–ª–µ–º)\n/bolus <—Ç–µ–∫.—Å–∞—Ö–∞—Ä> <—Ü–µ–ª—å> <–•–ï>")
            return
    except ValueError:
        await update.message.reply_text("‚ùå –í—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
        return

    correction = (current - target_glucose) / sensitivity if current > target_glucose else 0
    meal_dose = carbs * insulin_to_carb
    total = correction + meal_dose
    response = f"üìä **–†–∞—Å—á—ë—Ç –±–æ–ª—é—Å–∞:**\n"
    response += f"–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: {correction:.2f} –µ–¥\n"
    if carbs > 0:
        response += f"–ù–∞ –µ–¥—É ({carbs} –•–ï): {meal_dose:.2f} –µ–¥\n"
    response += f"**–ò–¢–û–ì–û: {total:.2f} –µ–¥**\n"
    if correction < 0:
        response += "‚ö†Ô∏è –°–∞—Ö–∞—Ä –Ω–∏–∂–µ —Ü–µ–ª–∏, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–∏–ª–∏ —Å–Ω–∏–∑—å—Ç–µ –¥–æ–∑—É)."
    await update.message.reply_text(response, parse_mode='Markdown')

# === –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ===
async def reminder(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if not context.args:
        # –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        reminders = db.get_active_reminders(user_id)
        if not reminders:
            await update.message.reply_text("‚è∞ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
            return
        msg = "‚è∞ **–ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:**\n"
        for rid, interval, next_tr in reminders:
            msg += f"  ID {rid}: –∫–∞–∂–¥—ã–µ {interval} –º–∏–Ω (—Å–ª–µ–¥. ~{next_tr[11:16]})\n"
        msg += "\n–û—Ç–º–µ–Ω–∏—Ç—å: /remind_cancel <id>"
        await update.message.reply_text(msg, parse_mode='Markdown')
        return

    try:
        minutes = int(context.args[0])
        if minutes <= 0:
            raise ValueError
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /remind <–º–∏–Ω—É—Ç—ã> (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)")
        return

    rid = db.add_reminder(user_id, minutes)
    context.job_queue.run_repeating(
        reminder_callback,
        interval=minutes*60,
        first=minutes*60,
        data=(user_id, rid),
        name=f"remind_{rid}"
    )
    await update.message.reply_text(f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ #{rid} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∂–¥—ã–µ {minutes} –º–∏–Ω—É—Ç.")

async def remind_cancel(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    try:
        rid = int(context.args[0])
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /remind_cancel <id>")
        return

    # –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
    db.deactivate_reminder(rid, user_id)
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ
    current_jobs = context.job_queue.get_jobs_by_name(f"remind_{rid}")
    for job in current_jobs:
        job.schedule_removal()
    await update.message.reply_text(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ #{rid} –æ—Ç–º–µ–Ω–µ–Ω–æ.")

async def reminder_callback(context: CallbackContext):
    job = context.job
    user_id, rid = job.data
    await context.bot.send_message(chat_id=user_id, text="üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–æ—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞—Ö–∞—Ä –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ä!")
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ –≤ –±–∞–∑–µ (–∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ—Ç –∂–µ, –Ω–æ next_trigger –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ)
    # –¢–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º run_repeating, —Ç–æ —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π, –Ω–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å next_trigger –≤ –±–∞–∑–µ.
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º next_trigger –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º –∑–∞–¥–∞–Ω–∏—è.

# === –≠–∫—Å–ø–æ—Ä—Ç ===
async def export_data(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    glucose = db.get_all_glucose(user_id)
    meals = db.get_all_meals(user_id)

    output = StringIO()
    writer = csv.writer(output)
    writer.writerow(["–¢–∏–ø", "–ó–Ω–∞—á–µ–Ω–∏–µ", "–í—Ä–µ–º—è"])

    for val, ts in glucose:
        writer.writerow(["–ì–ª—é–∫–æ–∑–∞", val, ts])
    for carbs, ts in meals:
        writer.writerow(["–ï–¥–∞ (–•–ï)", carbs, ts])

    output.seek(0)
    await update.message.reply_document(
        document=InputFile(output, filename=f"diabetes_data_{user_id}.csv"),
        caption="üìÅ –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π"
    )

# === –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ===
async def schedule_reminders(app: Application):
    """–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ."""
    reminders = db.get_due_reminders()  # –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –Ω–∞–¥–æ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ, –Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ–π–¥—ë–º—Å—è –ø–æ –≤—Å–µ–º
    # –õ—É—á—à–µ –≤—ã—Ç–∞—â–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ.
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ–ø—É—Å—Ç–∏–º: –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –æ–Ω–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞—á–Ω—É—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞.
    # –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∑–∂–µ.

def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("add_sugar", add_sugar))
    app.add_handler(CommandHandler("add_meal", add_meal))
    app.add_handler(CommandHandler("stats", stats))
    app.add_handler(CommandHandler("setprofile", setprofile))
    app.add_handler(CommandHandler("bolus", bolus))
    app.add_handler(CommandHandler("remind", reminder))
    app.add_handler(CommandHandler("remind_cancel", remind_cancel))
    app.add_handler(CommandHandler("export", export_data))

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling()

if __name__ == "__main__":
    main()

# === –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏ ===
import matplotlib
matplotlib.use('Agg')  # –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
import matplotlib.pyplot as plt
import io
from datetime import datetime, timedelta

async def stats_detailed(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    days = 7
    if context.args:
        try:
            days = int(context.args[0])
            if days <= 0:
                raise ValueError
        except:
            await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, /stats_detailed 14)")
            return
    
    stats = db.get_glucose_stats(user_id, days)
    if not stats:
        await update.message.reply_text(f"üìä –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∞—Ö–∞—Ä–µ.")
        return
    
    time_in_range = db.get_time_in_range(user_id, days)
    hba1c = db.estimate_hba1c(stats['avg'])
    
    msg = f"üìà **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {days} –¥–Ω.:**\n"
    msg += f"‚Ä¢ –ò–∑–º–µ—Ä–µ–Ω–∏–π: {stats['count']}\n"
    msg += f"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Å–∞—Ö–∞—Ä: {stats['avg']:.1f} –º–º–æ–ª—å\n"
    msg += f"‚Ä¢ –ú–∏–Ω/–ú–∞–∫—Å: {stats['min']:.1f} / {stats['max']:.1f} –º–º–æ–ª—å\n"
    msg += f"‚Ä¢ –í —Ü–µ–ª–µ–≤–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ (3.9-10.0): {time_in_range:.1f}%\n"
    msg += f"‚Ä¢ –û—Ü–µ–Ω–∫–∞ HbA1c: {hba1c:.1f}%"
    await update.message.reply_text(msg, parse_mode='Markdown')

async def plot(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    days = 7
    if context.args:
        try:
            days = int(context.args[0])
            if days <= 0:
                raise ValueError
        except:
            await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, /plot 14)")
            return
    
    stats = db.get_glucose_stats(user_id, days)
    if not stats or stats['count'] < 2:
        await update.message.reply_text(f"üìâ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞ {days} –¥–Ω–µ–π (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∑–∞–º–µ—Ä–∞).")
        return
    
    # –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫
    plt.figure(figsize=(10, 5))
    times = [datetime.fromisoformat(ts) for ts in stats['timestamps']]
    plt.plot(times, stats['values'], marker='o', linestyle='-', color='blue', label='–ì–ª—é–∫–æ–∑–∞')
    plt.axhline(y=3.9, color='green', linestyle='--', label='–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ (3.9)')
    plt.axhline(y=10.0, color='orange', linestyle='--', label='–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ (10.0)')
    plt.title(f'–î–∏–Ω–∞–º–∏–∫–∞ —Å–∞—Ö–∞—Ä–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π')
    plt.xlabel('–í—Ä–µ–º—è')
    plt.ylabel('–º–º–æ–ª—å/–ª')
    plt.legend()
    plt.grid(True)
    plt.xticks(rotation=45)
    plt.tight_layout()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—É—Ñ–µ—Ä
    buf = io.BytesIO()
    plt.savefig(buf, format='png')
    buf.seek(0)
    plt.close()
    
    await update.message.reply_photo(photo=buf, caption=f"üìä –ì—Ä–∞—Ñ–∏–∫ —Å–∞—Ö–∞—Ä–∞ –∑–∞ {days} –¥–Ω–µ–π")

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ main (–Ω–∏–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö)
# –í–ê–ñ–ù–û: –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å add_handler –¥–æ –≤—ã–∑–æ–≤–∞ app.run_polling()
# –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞, –≤—Å—Ç–∞–≤–∏–º –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–π–¥—ë—Ç —Ñ—É–Ω–∫—Ü–∏—é main –∏ –¥–æ–±–∞–≤–∏—Ç —Ç—É–¥–∞ —Å—Ç—Ä–æ–∫–∏.
# –ù–æ –ø—Ä–æ—â–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å main —Ü–µ–ª–∏–∫–æ–º. –°–¥–µ–ª–∞–µ–º —Ç–∞–∫: —Å–∫–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å —Ç–µ–∫—É—â–∏–π main –∏ –¥–æ–ø–∏—à–µ–º –≤ –Ω–µ–≥–æ –Ω–æ–≤—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã.
# –û–¥–Ω–∞–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç bot.py, –∏ –º—ã –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –≤ –∫–æ–Ω–µ—Ü. –ß—Ç–æ–±—ã –Ω–µ –Ω–∞—Ä—É—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —è —Å–æ–∑–¥–∞–º –Ω–æ–≤—ã–π –±–ª–æ–∫,
# –∫–æ—Ç–æ—Ä—ã–π –∑–∞–º–µ–Ω–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é main –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã —Å–¥–µ–ª–∞–ª–∏ –±—ç–∫–∞–ø.


# === –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø MAIN (—Å –Ω–æ–≤—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏) ===
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("add_sugar", add_sugar))
    app.add_handler(CommandHandler("add_meal", add_meal))
    app.add_handler(CommandHandler("stats", stats))
    app.add_handler(CommandHandler("setprofile", setprofile))
    app.add_handler(CommandHandler("bolus", bolus))
    app.add_handler(CommandHandler("remind", reminder))
    app.add_handler(CommandHandler("remind_cancel", remind_cancel))
    app.add_handler(CommandHandler("export", export_data))
    # –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("stats_detailed", stats_detailed))
    app.add_handler(CommandHandler("plot", plot))

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤...")
    app.run_polling()

if __name__ == "__main__":
    main()
