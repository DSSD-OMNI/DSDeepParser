from telegram import Update
from telegram.ext import CallbackContext
import database as db
import iob
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

async def setprofile(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if len(context.args) < 3:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /setprofile <—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å> <—É–≥–ª.–∫–æ—ç—Ñ> <—Ü–µ–ª—å>")
        return
    try:
        sens = float(context.args[0])
        ratio = float(context.args[1])
        target = float(context.args[2])
    except ValueError:
        await update.message.reply_text("‚ùå –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏")
        return
    db.set_user_settings(user_id, sens, ratio, target)
    await update.message.reply_text("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω")

async def bolus(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    settings = db.get_user_settings(user_id)
    if not settings:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–∞–Ω–¥–æ–π /setprofile")
        return
    sensitivity, insulin_to_carb, target = settings
    if len(context.args) < 1:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /bolus <—Ç–µ–∫—É—â–∏–π —Å–∞—Ö–∞—Ä> [—Ü–µ–ª—å] [–•–ï]")
        return
    try:
        current = float(context.args[0])
        if len(context.args) >= 3:
            target_glucose = float(context.args[1])
            carbs = float(context.args[2])
        else:
            target_glucose = target
            carbs = 0
    except ValueError:
        await update.message.reply_text("‚ùå –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏")
        return
    iob_amount = iob.get_iob(user_id)
    correction = (current - target_glucose) / sensitivity if current > target_glucose else 0
    meal_dose = carbs * insulin_to_carb
    total_before_iob = correction + meal_dose
    total = max(total_before_iob - iob_amount, 0)
    response = f"üìä **–†–∞—Å—á—ë—Ç –±–æ–ª—é—Å–∞:**\n"
    response += f"–ê–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω (IOB): {iob_amount} –µ–¥\n"
    response += f"–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: {correction:.2f} –µ–¥\n"
    if carbs > 0:
        response += f"–ù–∞ –µ–¥—É ({carbs} –•–ï): {meal_dose:.2f} –µ–¥\n"
    response += f"**–ò–¢–û–ì–û: {total:.2f} –µ–¥**\n"
    if correction < 0:
        response += "‚ö†Ô∏è –°–∞—Ö–∞—Ä –Ω–∏–∂–µ —Ü–µ–ª–∏, –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã."
    await update.message.reply_text(response, parse_mode='Markdown')

async def set_time_profile(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if len(context.args) < 5:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /set_time_profile <–Ω–∞—á–∞–ª–æ> <–∫–æ–Ω–µ—Ü> <—á—É–≤—Å—Ç–≤> <—É–≥–ª.–∫–æ—ç—Ñ> <—Ü–µ–ª—å>")
        return
    try:
        start = int(context.args[0])
        end = int(context.args[1])
        sens = float(context.args[2])
        ratio = float(context.args[3])
        target = float(context.args[4])
        if not (0 <= start <= 23 and 0 <= end <= 23):
            raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ß–∞—Å—ã –æ—Ç 0 –¥–æ 23")
        return
    db.set_time_profile(user_id, start, end, sens, ratio, target)
    await update.message.reply_text(f"‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è {start}:00-{end}:00 —Å–æ—Ö—Ä–∞–Ω—ë–Ω")

async def list_time_profiles(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    profiles = db.get_all_time_profiles(user_id)
    if not profiles:
        await update.message.reply_text("üìã –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π")
        return
    msg = "‚è∞ **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏:**\n"
    for start, end, sens, ratio, target in profiles:
        msg += f"‚Ä¢ {start}:00-{end}:00: —á—É–≤—Å—Ç–≤ {sens}, —É–≥–ª.–∫–æ—ç—Ñ {ratio}, —Ü–µ–ª—å {target}\n"
    await update.message.reply_text(msg, parse_mode='Markdown')

async def bolus_enhanced(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    current_hour = datetime.now().hour
    profile = db.get_time_profile(user_id, current_hour)
    if profile:
        sensitivity, insulin_to_carb, target = profile
    else:
        settings = db.get_user_settings(user_id)
        if not settings:
            await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–∞–Ω–¥–æ–π /setprofile –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏")
            return
        sensitivity, insulin_to_carb, target = settings
    if len(context.args) < 1:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /bolus_enhanced <—Ç–µ–∫—É—â–∏–π —Å–∞—Ö–∞—Ä> [—Ü–µ–ª—å] [–•–ï]")
        return
    try:
        current = float(context.args[0])
        if len(context.args) >= 3:
            target_glucose = float(context.args[1])
            carbs = float(context.args[2])
        else:
            target_glucose = target
            carbs = 0
    except ValueError:
        await update.message.reply_text("‚ùå –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏")
        return
    iob_amount = iob.get_iob(user_id)
    correction = (current - target_glucose) / sensitivity if current > target_glucose else 0
    meal_dose = carbs * insulin_to_carb
    total_before_iob = correction + meal_dose
    total = max(total_before_iob - iob_amount, 0)
    response = f"üìä **–†–∞—Å—á—ë—Ç –±–æ–ª—é—Å–∞ (—Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏):**\n"
    response += f"–ê–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—É–ª–∏–Ω (IOB): {iob_amount} –µ–¥\n"
    response += f"–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: {correction:.2f} –µ–¥\n"
    if carbs > 0:
        response += f"–ù–∞ –µ–¥—É ({carbs} –•–ï): {meal_dose:.2f} –µ–¥\n"
    response += f"**–ò–¢–û–ì–û: {total:.2f} –µ–¥**\n"
    await update.message.reply_text(response, parse_mode='Markdown')
