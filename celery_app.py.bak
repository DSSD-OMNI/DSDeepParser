from celery import Celery
from celery.schedules import crontab
import asyncio
import logging

app = Celery('dssd', broker='redis://localhost:6379/0')
app.conf.result_backend = 'redis://localhost:6379/0'

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Здесь будут задачи

@app.task
def run_etl():
    """Запуск ETL-процесса для текущего тура."""
    from packages.core.etl import run_etl_for_current_gw
    asyncio.run(run_etl_for_current_gw())
    logger.info("ETL completed")

@app.task
def train_model():
    """Запуск обучения новой модели."""
    from scripts.train_model import main
    main()
    logger.info("Training completed")

# Настройка расписания (раз в неделю)
app.conf.beat_schedule = {
    'run-etl-after-gw': {
        'task': 'celery_app.run_etl',
        'schedule': crontab(day_of_week='tue', hour=5, minute=0),  # каждый вторник в 5 утра
    },
    'train-model-weekly': {
        'task': 'celery_app.train_model',
        'schedule': crontab(day_of_week='wed', hour=3, minute=0),  # каждая среда в 3 утра
    },
}

@app.task
def update_targets():
    """Запуск обновления target для завершённого тура."""
    from scripts.update_targets import main
    main()

# Добавим в расписание (например, каждый вторник после тура)
app.conf.beat_schedule['update-targets-after-gw'] = {
    'task': 'celery_app.update_targets',
    'schedule': crontab(day_of_week='tue', hour=6, minute=0),  # вторник 6 утра
}
